<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<link rel="stylesheet" href="./css/1.12.x/jquery-ui.css">
<link rel="stylesheet" href="./css/style.css">
</head>
<body>
	<h1>JSでインタラクティブアートにチャレンジ</h1>
	<div>
		<table>
			<tbody>
				<tr>
					<!-- ローカルファイルを読み込むためのボタンを設置 -->
					<td>ファイルの指定</td>
					<td><input type="file" id="file"></td>
				</tr>
				<tr>
					<!-- 明るさを変更するためのレンジを設置 -->
					<td colspan="">明るさ</td>
					<td colspan="2"><input type="range" max="127" min="-127"
						step="1" value="0" id="brightness"> <input
						id="brightness_number" type="number" max="127" min="-127" step="1"
						value="0"></td>
				</tr>
				<tr>
					<!-- ダウンロードするためのリンクを設置 -->
					<td><a href="javascript: void 0;" id="download"
						download="download.png">ダウンロード</a></td>

					<!-- リセットリンクを設置 -->
					<td><a href="javascript: void 0;" onclick="reset()">リセット</a></td>
				</tr>
			</tbody>
		</table>
	</div>
	<div>
		<table>
			<tbody>
				<tr>
					<td>
						<!-- 画像を描画するキャンバスを設置 -->
						<canvas id="canvas"></canvas>
					</td>
				</tr>
			</tbody>
		</table>
	</div>

	<script src="./js/1.12.x/jquery-1.12.4.js"></script>
	<script src="./js/1.12.x/jquery-ui.js"></script>
	<script type="text/javascript">
		// グローバルスコープに必要な変数を定義
		var context = null;
		var img = new Image();
		var width = null;
		var height = null;
		var defaultPixelsData = null;

		// 画面ロード時の初期化処理
		$(function() {
			//canvas(canvas)のノードオブジェクトを取得
			var canvas = $('#canvas')[0];

			// キャンバスサイズの指定
			canvas.width = 300;
			canvas.height = 300;

			// キャンパスのサイズをグローバルに保存
			width = canvas.width;
			height = canvas.height;

			//2Dコンテキストをグローバルに保存
			context = canvas.getContext('2d');

			// ファイルの参照ボタンのチェンジイベントを定義
			$('#file').change(function(evt) {
				var file = evt.target.files;
				var reader = new FileReader();
				reader.readAsDataURL(file[0]);
				reader.onload = function() {
					img.src = reader.result;
				};
			});

			// 画像のロードイベントを定義
			$(img).load(
					function() {
						context.drawImage(img, 0, 0, width, height);
						if (!defaultPixelsData) {
							defaultPixelsData = context.getImageData(0, 0,
									width, height);
						}
						reset();
					});

			// 明るさレンジのチェンジイベントを定義
			$('#brightness').change(function() {
				if (!defaultPixelsData) {
					alert('画像が読み込まれていません');
					return false;
				}

				// この部分に追記
				// 明るさナンバーテキストに反映
				$('#brightness_number').val(this.value);

				changeBrightness(this.value);
			});

			// 明るさナンバーテキストのチェンジイベントを定義
			$('#brightness_number').change(function() {
				if (!defaultPixelsData) {
					alert('画像が読み込まれていません');
					return false;
				}

				// この部分に追記
				// 明るさレンジに反映
				$('#brightness').val(this.value);

				changeBrightness(this.value);
			});

			// ダウンロードリンクのクリックイベントを定義
			$("#download").click(function() {
				if (!defaultPixelsData) {
					alert('画像が読み込まれていません');
					return false;
				}
				this.href = canvas.toDataURL();
				return true;
			});

			// リセットリンクのクリックイベントを定義
			$("#reset").click(function() {
				reset();
				return true;
			});
		});

		// 明るさの変更処理
		var changeBrightness = function(changeVal) {
			// 一旦初期化
			context.putImageData(defaultPixelsData, 0, 0);

			// 数値型に変更
			changeVal = parseInt(changeVal, 10);

			// 1ピクセルずつ処理をする。
			// rgbaそれぞれ取得できる値は0から255の間の値。
			var pixels = context.getImageData(0, 0, width, height);
			for (var i = 0; i < pixels.data.length; i += 4) {
				pixels.data[i] += changeVal; // r
				pixels.data[i + 1] += changeVal; // g
				pixels.data[i + 2] += changeVal; // b
			}

			// 変更後のピクセルデータでCanvas上の内容を上書きする。
			context.putImageData(pixels, 0, 0);
		};

		// リセット処理
		var reset = function() {
			if (!defaultPixelsData) {
				return false;
			}
			$('#brightness').val(0);
			$('#brightness_number').val(0);
			context.putImageData(defaultPixelsData, 0, 0);
		};
	</script>
</body>
</html>
